services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: copilot-juridico:latest
    pull_policy: never
    working_dir: /app
    environment:
      PORT: ${PORT:-7860}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY:-2}
      WEB_THREADS: ${WEB_THREADS:-4}
      WEB_TIMEOUT: ${WEB_TIMEOUT:-120}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      MAX_TOKENS: ${MAX_TOKENS:-4096}
      TEMPERATURE: ${TEMPERATURE:-0.1}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-120}
      LLM_MAX_RETRIES: ${LLM_MAX_RETRIES:-3}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./outputs:/app/outputs
      - ./:/workspace:ro
    ports:
      - "${PORT:-7860}:7860"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:7860/healthz', timeout=5).read()"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
